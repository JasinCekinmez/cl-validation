````{R}
#installs libraries
library(DBI)
library(dbplyr)
library(dplyr)
library(duckdb)
library(duckplyr)
library(tidyr)
library(tidyselect)
library(tibble)
library(RSQLite)
library(stringr)

````



````{R}
#creates a database connection to cl.db which is the unzipped db file with deeds as the table
#db file
con=dbConnect(duckdb(),"/projects/SHARKEY/corelogic_pu/CorelogicDeeds/2023Update/cl.db")

#Adds DC to state.abb 
statenewabb=c("DC", state.abb)

#takes the database connection and turns it into a tibble and filters out non states and DC and ones that do not exist
fullData= tbl(con, "deeds")
fullData= fullData |> filter(`DEED SITUS STATE - STATIC` %in% statenewabb)




#fips =fullData |> filter(!is.na(`FIPS CODE`)) |> group_by(`FIPS CODE`) 
#print(fips)




#Takes out lowercase state abbreviations made me realize there are quite a bit of different non state abbreviations 
#yet there are still many typo caps 
#caps=fullData |> filter(str_detect(`DEED SITUS STATE - STATIC`,"[A-Z][A-Z]")||is.na(`DEED SITUS STATE - STATIC`)) |> group_by(`DEED SITUS STATE - STATIC`) |> summarize(n = n())
#print(caps)



#displays number of NON FMV data
#FMVData= fullData |> filter(`PRIMARY CATEGORY CODE`=="B"||`PRIMARY CATEGORY CODE`=="C"||`FORECLOSURE REO SALE INDICATOR`=="1"||`SALE TYPE CODE`=="L"||`INTERFAMILY RELATED INDICATOR`=="1"||`SHORT SALE INDICATOR`=="1")|> summarize(n=n())
#print(FMVData)


#Currently FMV DATA took a while to realize that the reason sale type code was causing issues was that it had NA Values 
#
FMVData= fullData |> filter(`PRIMARY CATEGORY CODE`!="B"&`PRIMARY CATEGORY CODE`!="C"&`FORECLOSURE REO SALE INDICATOR`!="1"& `INTERFAMILY RELATED INDICATOR`!="1" & `SHORT SALE INDICATOR`!="1") |>filter(`SALE TYPE CODE`!="L"||is.na(`SALE TYPE CODE`))
#print(FMVData)





#THIS SECTION looks at each group to see the most common type of each and which codes exist 
#Primtype= fullData |> group_by(`PRIMARY CATEGORY CODE`) |> summarize(n=n())
#print(Primtype)

#Cattype= fullData |> group_by(`DEED CATEGORY TYPE CODE`) |> summarize(n=n())
#print(Cattype)

#SaleType= fullData |> group_by(`SALE TYPE CODE`) |> summarize(n=n())
#print(SaleType)

#Saledoc = fullData |> group_by(`SALE DOCUMENT TYPE  CODE`) |> summarize(n=n())
#print(Saledoc)

#family= fullData |> group_by(`INTERFAMILY RELATED INDICATOR`) |> summarize(n=n())
#print(family)

#short= fullData |> group_by(`SHORT SALE INDICATOR`) |> summarize(n=n())
#print(short)

#foreclosure = fullData |> group_by(`FORECLOSURE REO SALE INDICATOR`) |> summarize(n=n())
#print(foreclosure)

#filters data to show how many deeds each state has at least listed 
StateData= fullData |> group_by(`DEED SITUS STATE - STATIC`) |> summarize(n = n())



##### THIS FINDS THE MEDIAN SALE DERIVED DATE YEAR FOR EACH STATE 
#QuartileData=fullData |> filter(`DEED SITUS STATE - STATIC`!="NA") |> select(`SALE DERIVED DATE`,`DEED SITUS STATE - STATIC`) |> mutate("SALE DERIVED YEAR"=substr(`SALE DERIVED DATE`,1,4)) |> group_by(`DEED SITUS STATE - STATIC`) |> select(-`SALE DERIVED DATE`) |> summarize(Median = median(as.numeric(`SALE DERIVED YEAR`),na.rm = TRUE ))


#finds the 2.5% quantile for each state 
QuantileStateData = fullData |> filter(`DEED SITUS STATE - STATIC`!="NA") |> select(`SALE DERIVED DATE`,`DEED SITUS STATE - STATIC`) |> mutate("SALE DERIVED YEAR"=substr(`SALE DERIVED DATE`,1,4)) |> group_by(`DEED SITUS STATE - STATIC`) |>
summarize(quantile2.5Year = quantile(as.numeric(`SALE DERIVED YEAR`), na.rm = T, probs = c(.025)))


#finds the 2.5% for each county 
QuantileCountyData= fullData |> filter(`DEED SITUS STATE - STATIC`!="NA") |> select(`SALE DERIVED DATE`,`DEED SITUS COUNTY - STATIC` ,`DEED SITUS STATE - STATIC`) |> mutate("SALE DERIVED YEAR"=substr(`SALE DERIVED DATE`,1,4)) |> group_by(`DEED SITUS COUNTY - STATIC`,`DEED SITUS STATE - STATIC`) |> summarize(quantile2.5Year = quantile(as.numeric(`SALE DERIVED YEAR`), na.rm = T, probs = c(.025)))




# finds the number of rows 
#result <- dbGetQuery(con, "SELECT COUNT(*) AS row_count FROM deeds")
# Extract the row count from the result
#row_count <- result$row_count
# Print the row count
#print(row_count)


# this code helped me realize mistakes present in the data 
#filters data to show how many deeds each state has at least listed 
#CountyData= fullData|>filter(`DEED SITUS STATE - STATIC`!="NA")|> filter(`DEED SITUS COUNTY - STATIC`=="SAN DIEGO" & `DEED SITUS STATE - STATIC` != "CA") #|> #filter(`DEED SITUS STATE - STATIC` != "CA" ) 
#print(CountyData)

# countydata 
CountyData= fullData |> filter(`DEED SITUS STATE - STATIC` != "NA") |> group_by(`DEED SITUS COUNTY - STATIC`,`DEED SITUS STATE - STATIC`) |> summarize(n = n())


# Here I realized that the county may be listed, but the state may not be but not the converse as I have seen with previous tests 
#SANDDATA=fullData |>filter(`DEED SITUS STATE - STATIC`!="NA") |> filter(`DEED SITUS COUNTY - STATIC`=="SAN DIEGO") |> summarize(n = n())
#print(SANDDATA)



#creates tibble for each column and reports the missingness 
tibbleCreator= function(column, region) {
#turns column into variable rather than string
column=as.name(column)
if(region=="DEED SITUS STATE - STATIC"){
#filters entire data by state and disregards NA values and gives the total number of deeds per state satisfying the condition
  region=as.name(region)
data = (fullData |> group_by(region) |>filter(column !="NA") |> summarize(n = n()))
#the above table is now being appended to the right by the total # of deeds per state 
region=toString(region)
data  = left_join(data, StateData, by=region)
#column1=paste0(column," Present") doesn't do anything so I manually change the column name outside the function
#@ANGELA, do you have an idea of how to change the column name within the function 
data= data |> rename(column1= `n.x`, "Total Deeds" = `n.y`)
#changes column names 
data= data |> mutate("% missing"= round((100* (1-((`column1`)/(`Total Deeds`)))), digits=2)) 
#Now gives the missingness 

#THE CSV FILE CREATED WILL DISPLAY COLUMN1 BUT THE CSV FILE NAME SHOULD TELL YOU WHAT TO 
#RENAME THE COLUMN TO 
#CREATES CSV File
column=toString(column)
csvtitle=paste0(column,region,".csv")
write.csv(data,csvtitle)



return(data)}
else{
region=as.name(region)
data = fullData |>filter(column != "NA") |> filter(`DEED SITUS STATE - STATIC` != "NA" ) |> group_by(region,`DEED SITUS STATE - STATIC`)  |> summarize(n = n()) 
region=toString(region)       
data= data|> left_join(CountyData, data, by=c(region,"DEED SITUS STATE - STATIC")) 

#column1=paste0(column," Present") doesn't do anything so I manually change the column name outside the function
#@ANGELA, do you have an idea of how to change the column name within the function 

data= data |> rename(column1= `n.x`, "Total Deeds" = `n.y`)


data= data |> mutate("% missing"= round((100* (1-((`column1`)/(`Total Deeds`)))), digits=2)) 
#Now gives the missingness 

#THE CSV FILE CREATED WILL DISPLAY COLUMN1 BUT THE CSV FILE NAME SHOULD TELL YOU WHAT TO 
#RENAME THE COLUMN TO 
#CREATES CSV File
column=toString(column)
csvtitle=paste0(column,region,".csv")
write.csv(data,csvtitle)


return(data)
}}

#### IMPORTANT THIS NEXT SECTION CREATES TABLE FOR THE DATA ASCRIBED FOR STATE AND COUNTY


#data=tibbleCreator("SALE AMOUNT","DEED SITUS COUNTY - STATIC")
#data =data |> rename("SALE AMOUNT Present" = `column1`) 
#print(data)

#data=tibbleCreator("APN SEQUENCE NUMBER","DEED SITUS COUNTY - STATIC")
#data =data |> rename("APN SEQUENCE NUMBER Present" = `column1`) 
#print(data)

#data=tibbleCreator("DEED SITUS CITY - STATIC","DEED SITUS COUNTY - STATIC")
#data =data |> rename("DEED SITUS CITY - STATIC" = `column1`) 
#data=data |> arrange(desc(`DEED SITUS STATE - STATIC`))
#ASK ANGELA WHAT TO DO WITH LOWERCASE AND INCORRECT CASES 
#print(data)

#data=tibbleCreator("DEED SITUS ZIP CODE - STATIC","DEED SITUS COUNTY - STATIC")
#data =data |> rename("DEED SITUS ZIP CODE - STATIC Present" = `column1`) 
#data=data |> arrange(desc(`DEED SITUS COUNTY - STATIC`))
#print(data)

#data=tibbleCreator("SALE DERIVED DATE","DEED SITUS COUNTY - STATIC")
#data =data |> rename("SALE DERIVED DATE Present" = `column1`) 
#print(data)

#data=tibbleCreator("SALE DERIVED RECORDING DATE","DEED SITUS COUNTY - STATIC")
#data =data |> rename("SALE DERIVED RECORDING DATE Present" = `column1`) 
#print(data)


#data=tibbleCreator("LAND USE CODE - STATIC","DEED SITUS COUNTY - STATIC")
#data =data |> rename("LAND USE CODE - STATIC Present" = `column1`) 
#print(data)

#data=tibbleCreator("ACTUAL YEAR BUILT - STATIC","DEED SITUS COUNTY - STATIC")
#data =data |> rename("ACTUAL YEAR BUILT - STATIC Present" = `column1`) 
#print(data)

#data=tibbleCreator("PROPERTY INDICATOR CODE - STATIC","DEED SITUS COUNTY - STATIC")
#data =data |> rename("PROPERTY INDICATOR CODE - STATIC Present" = `column1`) 
#print(data)

data=tibbleCreator("PROPERTY INDICATOR CODE - STATIC","DEED SITUS STATE - STATIC")
data =data |> rename("PROPERTY INDICATOR CODE - STATIC Present" = `column1`) 
print(data)

# checks missingness of APN Sequence Number by state 
#data=tibbleCreator("APN SEQUENCE NUMBER","DEED SITUS STATE - STATIC")
#data =data |> rename("APN SEQUENCE NUMBER Present" = `column1`) 
#print(data)


# checks missingness of city by state 
#data=tibbleCreator("DEED SITUS CITY - STATIC","DEED SITUS STATE - STATIC")
#data =data |> rename("DEED SITUS CITY - STATIC Present" = `column1`) 
#print(data)


### IMPORTANT IF WE KNOW THE STATE OF THE DEED WE WILL ALWAYS KNOW THE COUNTY OF THE DEED BUT NOT THE CONVERSE
# checks missingness of county by state 
#tibbleCreator("DEED SITUS COUNTY - STATIC")
#data=tibbleCreator("DEED SITUS COUNTY - STATIC")
#data =data |> rename("DEED SITUS COUNTY - STATIC Present" = `column1`) 
#print(data)


# checks missingness of zipcode by state 
#data=tibbleCreator( "DEED SITUS ZIP CODE - STATIC","DEED SITUS STATE - STATIC")
#data =data |> rename( "DEED SITUS ZIP CODE - STATIC Present" = `column1`) 
#print(data)

# checks missingness of Sale Amount by state 
#data=tibbleCreator(  "SALE AMOUNT","DEED SITUS STATE - STATIC")
#data =data |> rename(  "SALE AMOUNT Present" = `column1`) 
#print(data)

# checks missingness of Sale Derived Rate by state"
#data=tibbleCreator("SALE DERIVED DATE","DEED SITUS STATE - STATIC")
#data =data |> rename( "SALE DERIVED DATE Present" = `column1`) 
#print(data)

# checks missingness of Sale Derived Date by state"
#data=tibbleCreator( "SALE DERIVED RECORDING DATE","DEED SITUS STATE - STATIC")
#data =data |> rename(  "SALE DERIVED RECORDING DATE Present" = `column1`) 
#print(data)

# checks missingness of Land Use Code by state"
#data=tibbleCreator("LAND USE CODE - STATIC","DEED SITUS STATE - STATIC")
#data =data |> rename(  "LAND USE CODE - STATIC Present" = `column1`) 
#print(data)

# checks missingness of build year by state"
#data=tibbleCreator("ACTUAL YEAR BUILT - STATIC","DEED SITUS STATE - STATIC")
#data =data |> rename("ACTUAL YEAR BUILT - STATIC Present" = `column1`) 
#print(data)





#disconnects in order to avoid garbage collecting 
dbDisconnect(con)


````